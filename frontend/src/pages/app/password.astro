---
import Layout from "@layouts/Layout.astro"
---
<Layout title="Changer mon mot de passe">
  <main class="flex-1 flex flex-col gap-4 items-center p-4 justify-center">
  <section class="w-full max-w-md">
  <h1 class="font-semibold text-2xl text-blue-800 bg-white mb-1">Changer mon mot de passe</h1>
    <form id="pw" style="display:grid;gap:.75rem;max-width:360px">

      <input 
      name="old_password" 
      type="password" 
      placeholder="Ancien mot de passe" 
      class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
      required />

      <input name="new_password" 
      type="password" 
      placeholder="Nouveau mot de passe (min 8)" 
      minlength="8" 
      class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
      required />

      <button class="rounded-lg border-2 border-blue-900 bg-blue-900 px-4 py-2 text-white transition duration-150 hover:bg-blue-50 hover:text-blue-900">Mettre à jour</button>
      <div id="msg" aria-live="polite"></div>
    </form>
  <style>
    .stack { display:flex; flex-direction:column; gap:.8rem; max-width:380px }
    input, button { padding:.55rem .7rem; font-size:1rem }
  </style>
  </section>
  </main>
</Layout>
<script>
  (async () => {
    const r = await fetch('/api/me', { credentials:'include' });
    if (!r.ok) return location.href = '/login?next=' + encodeURIComponent(location.pathname);
  })();

  document.getElementById('pw').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = document.getElementById('msg'); msg.className=''; msg.textContent='';
    const data = Object.fromEntries(new FormData(e.target).entries());
    const r = await fetch('/api/auth/change-password', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data),
      credentials:'include'
    });
    if (r.ok) { msg.className='ok'; msg.textContent = 'Mot de passe mis à jour ✅'; }
    else { try { const j=await r.json(); msg.className='err'; msg.textContent = j.error || 'Erreur'; } catch { msg.textContent='Erreur'; } }
  });
</script>


